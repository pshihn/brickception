!function(){"use strict";let e,t;const s={},i=t=>t.reduce((e,t)=>e?e[t]:e,e);async function a(t){const a=t.data;let n,h,o;if(n=a&&a.id)if((h=a.type)&&e){a.path=a.path||[];const e={id:n},s=i(a.path),o=i(a.path.slice(0,-1));switch(h){case"G":e.value=s;break;case"S":const i=a.path.length&&a.path.pop();i&&(o[i]=a.value);break;case"A":try{e.value=await s.apply(o,a.args||[])}catch(t){e.error=t.toString()}}t.source.postMessage(e,"*")}else(o=s[n])&&(delete s[n],a.error?o[1](new Error(a.error)):o[0](a.value))}function n(){t||(self.addEventListener("message",a),t=!0)}function h(e){return function e(t,s){return s=s||[],new Proxy(function(){},{get(i,a,n){if("then"===a){if(0===s.length)return{then:()=>n};const e=t({type:"G",path:s});return e.then.bind(e)}return e(t,s.concat(a))},set:(e,i,a)=>t({type:"S",path:s.concat(i),value:a}),apply:(e,i,a)=>t({type:"A",path:s,args:a})})}(function(e){const t=`${Date.now()}-${Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)}`;let i=0;return n(),a=>{const n=a.args||[],h=`${t}-${++i}`;return new Promise((t,i)=>{s[h]=[t,i],e.postMessage(Object.assign({},a,{id:h,args:n}),"*")})}}(e))}const o=8,r=4,d=60,l=20,c=4,g=4,w=5,u="menubar=no,toolbar=no,location=no,personalbar=no,status=no,dependent=yes,minimizable=no,resizable=no,scrollbars=no";class m{constructor(t){this.windowsWon=0,this.windowsReady=0,this.ballLaunching=!1,this.listener=t,this.gameState={level:1,livesLeft:w,score:0},function(t){e=t,n()}(this)}start(){this.closeWindows(),this.gameState={level:1,livesLeft:w,score:0},this.listener.gameStateChanged(this.gameState),this.windowsWon=0,this.windowsReady=0,this.ballLaunching=!1;const e=window.screen.availHeight||window.screen.height,t=window.screen.availWidth||window.screen.width,s=Math.min(e-80,800),i=this.openWindow("base",Math.min(1e3,t-20),s,0),a=this.openWindow("paddle",400,300,s-300);if(!i||!a)throw i&&i.close(),a&&a.close(),new Error("Failed to launch game windows. Ensure that popups are enabled for this site.");this.base={win:i,game:h(i)},this.paddle={win:a,game:h(a)},i.addEventListener("beforeunload",()=>this.gameOver()),a.addEventListener("beforeunload",()=>this.gameOver())}openWindow(e,t,s,i){const a=window.screenLeft||window.screenX;let n=0;n=a<0&&Math.abs(a)>t?a+Math.round((Math.abs(a)-t)/2):(n=(window.screen.availWidth||window.screen.width)-t)>0?n/2:0;const h=window.open("./game.html",e,`${u},top=${i},left=${n},width=${t},height=${s}`);return h&&h.focus(),h}closeWindows(){this.base&&!this.base.win.closed&&(this.base.win.close(),this.base=void 0),this.paddle&&!this.paddle.win.closed&&(this.paddle.win.close(),this.paddle=void 0)}updateState(){this.base&&this.paddle&&(this.base.game.setState(this.gameState),this.paddle.game.setState(this.gameState)),this.listener.gameStateChanged(this.gameState)}setGameLabel(e){this.base&&this.paddle&&(this.base.game.setLabel(e),this.paddle.game.setLabel(e))}launchBalls(){this.base&&this.paddle&&!this.ballLaunching&&(this.ballLaunching=!0,this.base.game.stop(),this.paddle.game.stop(),this.launchTick(3))}launchTick(e){0===e?this.base&&this.paddle&&(this.ballLaunching=!1,this.setGameLabel(""),this.base.game.launchBall(),this.paddle.game.launchBall()):(this.setGameLabel(`${e}`),setTimeout(()=>{this.base&&this.paddle&&this.launchTick(e-1)},1e3))}ready(){this.windowsReady++,2===this.windowsReady&&(this.initializeWindows(),this.launchBalls())}initializeWindows(){this.base.game.initialize({ballRadius:o,baseSpeed:r,brickGap:c,brickHeight:l,brickWidth:d,rowCount:g,paddleWindow:!1},this.gameState),this.paddle.game.initialize({ballRadius:o/2,baseSpeed:r/2,brickGap:c/2,brickHeight:l/2,brickWidth:d/2,rowCount:g,paddleWindow:!0},this.gameState)}died(){this.gameState.livesLeft--,0===this.gameState.livesLeft?this.gameOver():(this.updateState(),this.launchBalls())}hit(e){if(this.gameState.score++,!e&&(this.windowsWon++,2===this.windowsWon))return this.gameState.level++,this.windowsWon=0,this.initializeWindows(),this.setGameLabel(`Level ${this.gameState.level}!`),void setTimeout(()=>{this.launchBalls()},3e3);this.updateState()}async getPaddlePosition(){if(this.paddle&&this.base){const e=this.base.win.outerHeight-this.base.win.innerHeight,t=this.paddle.win.screenX-this.base.win.screenX;return{x:t,y:this.paddle.win.screenY-this.base.win.screenY-e,width:this.paddle.win.outerWidth,xr:t/this.base.win.innerWidth}}return{x:0,y:0,xr:0,width:1}}gameOver(){this.gameState.livesLeft=0,this.closeWindows(),this.listener.gameStateChanged(this.gameState),this.listener.appStateChanged({state:"over"})}}function p(e){return document.getElementById(e)}function b(e,t){e.textContent=`${t}`}const S={get(e){if(!e)return null;const t=localStorage.getItem(e);return t?JSON.parse(t):null},set(e,t){e&&t&&("string"==typeof t?localStorage.setItem(e,t):localStorage.setItem(e,JSON.stringify(t)))}},v=document.querySelector("main"),L=p("gameView"),f=p("stateTitle"),y=p("level"),W=p("balls"),k=p("score"),E=p("hiscore"),G=p("stopButton"),$=p("homeButton"),B=p("replayButton"),M=p("launchButton"),C="game-data";const O=new class{constructor(){this.appState="home",this.engine=new m(this),this.storedData=S.get(C)||{hiscore:0},this.updateHiScore(),G.addEventListener("click",()=>this.engine.gameOver())}appStateChanged(e){this.error=e.error,this.setState(e.state)}gameStateChanged(e){b(y,e.level),b(W,e.livesLeft),b(k,e.score)}updateHiScore(){b(E,this.storedData.hiscore)}setState(e){if(this.appState!==e){const t=this.appState;switch(this.appState=e,e){case"home":this.engine.closeWindows(),v.classList.remove("hidden"),L.classList.add("hidden");break;case"running":"home"===t&&(v.classList.add("hidden"),L.classList.remove("hidden"));try{this.engine.start()}catch(e){this.error=e,this.setState("error")}b(f,"Game in progress"),G.classList.remove("hidden"),$.classList.add("hidden"),B.classList.add("hidden");break;case"error":this.error&&(this.error.message||(this.error.message="Ooops! Something went wrong. Try again."),setTimeout(()=>{window.alert(this.error.message)},1e3)),this.setState("home");break;case"over":const s=this.engine.gameState.score;s>this.storedData.hiscore?(this.storedData.hiscore=s,S.set(C,this.storedData),b(f,"Game over. high score!")):b(f,"Game over!"),this.updateHiScore(),G.classList.add("hidden"),$.classList.remove("hidden"),B.classList.remove("hidden")}}}};M.addEventListener("click",()=>O.setState("running")),B.addEventListener("click",()=>O.setState("running")),$.addEventListener("click",()=>O.setState("home"))}();
